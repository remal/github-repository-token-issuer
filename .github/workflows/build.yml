name: build

on:
  push:
    branches:
    - main
  pull_request: { }
  workflow_dispatch: { }

permissions:
  contents: read
  id-token: write

concurrency:
  group: build-${{github.ref}}
  cancel-in-progress: true

defaults:
  run:
    shell: bash

jobs:
  build:
    if: >-
      ${{
        (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/'))
        || (github.event_name == 'push' && !contains(github.event.head_commit.message, '[push-back]') && !contains(github.event.head_commit.message, '[noci]') && !contains(github.event.head_commit.message, '[no-ci]'))
        || github.event_name != 'push'
      }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
    - name: Checkout repository
      uses: actions/checkout@v6

    - name: GCP - Authenticate
      uses: google-github-actions/auth@v3
      with:
        workload_identity_provider: projects/74155037973/locations/global/workloadIdentityPools/github-pool/providers/remal-gh-repo-token-issuer
        service_account: gh-remal-gh-repo-token-issuer@gh-repo-token-issuer.iam.gserviceaccount.com

    - name: Go - Setup
      uses: actions/setup-go@v6
      with:
        go-version: '1.25'
        cache-dependency-path: function/go.sum
    - name: Go - Build
      working-directory: ./function
      run: go build ./...
    - name: Go - Vet
      working-directory: ./function
      run: go vet ./...
    - name: Go - Lint
      uses: golangci/golangci-lint-action@v9
      with:
        working-directory: function
    - name: Go - Test
      working-directory: ./function
      run: go test -v ./...
      env:
        GITHUB_APP_ID: "1"

    - name: Terraform - Read version
      id: terraform-version
      run: echo "version=$(cat .terraform-version | tr -d '[:space:]')" >> $GITHUB_OUTPUT
    - name: Terraform - Setup
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{steps.terraform-version.outputs.version}}
    - name: Terraform - Init
      working-directory: ./terraform
      run: terraform init
    - name: Terraform - Validate
      working-directory: ./terraform
      run: terraform validate
    - name: Terraform - Plan
      working-directory: ./terraform
      run: terraform plan

  deploy:
    needs:
    - build
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
    - name: Checkout repository
      uses: actions/checkout@v6

    - name: GCP - Authenticate
      uses: google-github-actions/auth@v3
      with:
        workload_identity_provider: projects/74155037973/locations/global/workloadIdentityPools/github-pool/providers/remal-gh-repo-token-issuer
        service_account: gh-remal-gh-repo-token-issuer@gh-repo-token-issuer.iam.gserviceaccount.com

    - name: Terraform - Read version
      if: ${{github.ref == 'refs/heads/main'}}
      id: terraform-version
      run: echo "version=$(cat .terraform-version | tr -d '[:space:]')" >> $GITHUB_OUTPUT
    - name: Terraform - Setup
      if: ${{github.ref == 'refs/heads/main'}}
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{steps.terraform-version.outputs.version}}
    - name: Terraform - Init
      if: ${{github.ref == 'refs/heads/main'}}
      working-directory: ./terraform
      run: terraform init
    - name: Terraform - Apply
      if: ${{github.ref == 'refs/heads/main'}}
      working-directory: ./terraform
      run: terraform apply -auto-approve

    - name: Go - Setup
      uses: actions/setup-go@v6
      with:
        go-version: '1.25'
        cache-dependency-path: function/go.sum
    - name: Go - Build
      working-directory: ./function
      env:
        CGO_ENABLED: '0'
        GOOS: linux
        GOARCH: amd64
      run: go build -ldflags="-s -w" -o function .

    - name: Install gcloud SDK
      uses: google-github-actions/setup-gcloud@v3

    - name: Configure Docker for Artifact Registry
      run: gcloud auth configure-docker us-east4-docker.pkg.dev --quiet

    - name: Build and push Docker image
      working-directory: ./function
      run: |
        SHORT_SHA=$(git rev-parse --short HEAD)
        docker build -t us-east4-docker.pkg.dev/gh-repo-token-issuer/gh-repo-token-issuer/function:${SHORT_SHA} .
        docker push us-east4-docker.pkg.dev/gh-repo-token-issuer/gh-repo-token-issuer/function:${SHORT_SHA}

    - name: Deploy to Cloud Run (no traffic)
      run: |
        SHORT_SHA=$(git rev-parse --short HEAD)
        gcloud run deploy gh-repo-token-issuer \
          --image=us-east4-docker.pkg.dev/gh-repo-token-issuer/gh-repo-token-issuer/function:${SHORT_SHA} \
          --region=us-east4 \
          --no-traffic \
          --tag=commit-${SHORT_SHA}

    - name: Validate deployed revision
      run: |
        SHORT_SHA=$(git rev-parse --short HEAD)
        CANARY_URL="https://commit-${SHORT_SHA}---gh-repo-token-issuer-db7udto7gq-uk.a.run.app/token?contents=write"

        # Step 1: Get GitHub OIDC token (emulates user flow)
        # Audience must match the oidc_audience configured in Workload Identity Pool Provider
        GITHUB_OIDC_TOKEN=$(curl -sS -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
          "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=gh-repo-token-issuer" | jq -r '.value')
        echo "::add-mask::$GITHUB_OIDC_TOKEN"

        # Step 2: Exchange GitHub OIDC token for GCP access token via STS API
        # This uses the users-github-actions pool (same as real users would)
        STS_RESPONSE=$(curl -sS -X POST \
          -H "Content-Type: application/x-www-form-urlencoded" \
          --data-urlencode "grant_type=urn:ietf:params:oauth:grant-type:token-exchange" \
          --data-urlencode "subject_token_type=urn:ietf:params:oauth:token-type:jwt" \
          --data-urlencode "subject_token=${GITHUB_OIDC_TOKEN}" \
          --data-urlencode "audience=//iam.googleapis.com/projects/74155037973/locations/global/workloadIdentityPools/users-github-actions/providers/users-github-oidc" \
          "https://sts.googleapis.com/v1/token")

        GCP_ACCESS_TOKEN=$(echo "$STS_RESPONSE" | jq -r '.access_token')
        if [ -z "$GCP_ACCESS_TOKEN" ] || [ "$GCP_ACCESS_TOKEN" = "null" ]; then
          echo "Failed to exchange GitHub OIDC token for GCP access token"
          echo "$STS_RESPONSE"
          exit 1
        fi
        echo "::add-mask::$GCP_ACCESS_TOKEN"

        # Step 3: Call Cloud Run with both tokens
        RESPONSE=$(curl -sS -w "\n%{http_code}" \
          -H "Authorization: Bearer $GCP_ACCESS_TOKEN" \
          -H "X-GitHub-Token: $GITHUB_OIDC_TOKEN" \
          "$CANARY_URL")
        HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
        BODY=$(echo "$RESPONSE" | sed '$d')

        if [ "$HTTP_CODE" != "200" ]; then
          echo "Token request failed with status $HTTP_CODE"
          echo "$BODY"
          exit 1
        fi

        TOKEN=$(echo "$BODY" | jq -r '.token')
        if [ -z "$TOKEN" ] || [ "$TOKEN" = "null" ]; then
          echo "Failed to extract token from response"
          echo "$BODY"
          exit 1
        fi
        echo "::add-mask::$TOKEN"

        # Validate token scopes via GitHub API
        SCOPES=$(curl -sI -H "Authorization: Bearer $TOKEN" \
          https://api.github.com/user | grep -i "x-oauth-scopes:" | cut -d' ' -f2- | tr -d '\r')

        echo "Returned scopes: $SCOPES"

        # Check if contents scope is present
        if echo "$SCOPES" | grep -q "contents"; then
          echo "Scope validation passed"
        else
          echo "Scope validation failed: expected 'contents' in scopes"
          exit 1
        fi

    - name: Migrate traffic to new revision
      if: ${{github.ref == 'refs/heads/main'}}
      run: |
        SHORT_SHA=$(git rev-parse --short HEAD)
        gcloud run services update-traffic gh-repo-token-issuer \
          --region=us-east4 \
          --to-tags=commit-${SHORT_SHA}=100

