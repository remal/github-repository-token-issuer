name: build

on:
  push:
    branches:
    - main
  pull_request: { }
  workflow_dispatch: { }

permissions:
  contents: read
  id-token: write

concurrency:
  group: build-${{github.ref}}
  cancel-in-progress: true

defaults:
  run:
    shell: bash

jobs:
  build:
    if: >-
      ${{
        (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/'))
        || (github.event_name == 'push' && !contains(github.event.head_commit.message, '[push-back]') && !contains(github.event.head_commit.message, '[noci]') && !contains(github.event.head_commit.message, '[no-ci]'))
        || github.event_name != 'push'
      }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
    - name: Checkout repository
      uses: actions/checkout@v6

    - name: GCP - Authenticate
      uses: google-github-actions/auth@v3
      with:
        workload_identity_provider: projects/74155037973/locations/global/workloadIdentityPools/github-pool/providers/remal-gh-repo-token-issuer
        service_account: gh-remal-gh-repo-token-issuer@gh-repo-token-issuer.iam.gserviceaccount.com

    - name: Terraform - Read version
      id: terraform-version
      run: echo "version=$(cat .terraform-version | tr -d '[:space:]')" >> $GITHUB_OUTPUT
    - name: Terraform - Setup
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{steps.terraform-version.outputs.version}}
    - name: Terraform - Init
      working-directory: ./terraform
      run: terraform init
    - name: Terraform - Validate
      working-directory: ./terraform
      run: terraform validate
    - name: Terraform - Plan
      working-directory: ./terraform
      run: terraform plan

    - name: Go - Setup
      uses: actions/setup-go@v6
      with:
        go-version: '1.25'
        cache-dependency-path: function/go.sum
    - name: Go - Build
      working-directory: ./function
      run: go build ./...
    - name: Go - Vet
      working-directory: ./function
      run: go vet ./...
    - name: Go - Lint
      uses: golangci/golangci-lint-action@v9
      with:
        working-directory: function
    - name: Go - Test
      working-directory: ./function
      run: go test -v ./...
      env:
        GITHUB_APP_ID: "1"

  deploy:
    needs:
    - build
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
    - name: Checkout repository
      uses: actions/checkout@v6

    - name: GCP - Authenticate
      uses: google-github-actions/auth@v3
      with:
        workload_identity_provider: projects/74155037973/locations/global/workloadIdentityPools/github-pool/providers/remal-gh-repo-token-issuer
        service_account: gh-remal-gh-repo-token-issuer@gh-repo-token-issuer.iam.gserviceaccount.com

    - name: Terraform - Read version
      if: ${{github.ref == 'refs/heads/main'}}
      id: terraform-version
      run: echo "version=$(cat .terraform-version | tr -d '[:space:]')" >> $GITHUB_OUTPUT
    - name: Terraform - Setup
      if: ${{github.ref == 'refs/heads/main'}}
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{steps.terraform-version.outputs.version}}
    - name: Terraform - Init
      if: ${{github.ref == 'refs/heads/main'}}
      working-directory: ./terraform
      run: terraform init
    - name: Terraform - Apply
      if: ${{github.ref == 'refs/heads/main'}}
      working-directory: ./terraform
      run: terraform apply -auto-approve

    - name: Go - Setup
      uses: actions/setup-go@v6
      with:
        go-version: '1.25'
        cache-dependency-path: function/go.sum
    - name: Go - Build
      working-directory: ./function
      env:
        CGO_ENABLED: '0'
        GOOS: linux
        GOARCH: amd64
      run: go build -ldflags="-s -w" -o function .

    - name: Install gcloud SDK
      uses: google-github-actions/setup-gcloud@v3

    - name: Configure Docker for Artifact Registry
      run: gcloud auth configure-docker us-east4-docker.pkg.dev --quiet

    - name: Build and push Docker image
      working-directory: ./function
      run: |
        SHORT_SHA=$(git rev-parse --short HEAD)
        docker build -t us-east4-docker.pkg.dev/gh-repo-token-issuer/gh-repo-token-issuer/function:${SHORT_SHA} .
        docker push us-east4-docker.pkg.dev/gh-repo-token-issuer/gh-repo-token-issuer/function:${SHORT_SHA}

    - name: Deploy to Cloud Run (no traffic)
      run: |
        SHORT_SHA=$(git rev-parse --short HEAD)
        gcloud run deploy gh-repo-token-issuer \
          --image=us-east4-docker.pkg.dev/gh-repo-token-issuer/gh-repo-token-issuer/function:${SHORT_SHA} \
          --region=us-east4 \
          --no-traffic \
          --tag=commit-${SHORT_SHA}

    - name: Get short SHA
      id: short-sha
      run: echo "value=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

    - name: Validate deployed revision
      id: validate
      uses: ./
      with:
        scopes: |
          contents:write
        service_tag: commit-${{steps.short-sha.outputs.value}}

    - name: Verify token permissions
      run: |
        # Verify token permissions
        PERMS=$(curl -sS -H "Authorization: Bearer ${{steps.validate.outputs.token}}" \
          "https://api.github.com/repos/${{github.repository}}" | jq -r '.permissions.push // false')
        echo "Push permission: $PERMS"
        if [[ "$PERMS" == "true" ]]; then
          echo "Permission validation passed"
        else
          echo "Permission validation failed: expected push=true for contents:write"
          exit 1
        fi

    - name: Migrate traffic to new revision
      if: ${{github.ref == 'refs/heads/main'}}
      run: |
        SHORT_SHA=$(git rev-parse --short HEAD)
        gcloud run services update-traffic gh-repo-token-issuer \
          --region=us-east4 \
          --to-tags=commit-${SHORT_SHA}=100

